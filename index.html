<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGallery Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --accent-color: #38bdf8;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            width: 100%;
            padding: 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* --- Layout --- */
        .container {
            width: 90%;
            max-width: 1200px;
            margin-top: 30px;
            text-align: center;
            flex-grow: 1;
        }

        .panel { display: none; animation: fadeIn 0.4s ease-out; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Host UI (PC) --- */
        #qr-container {
            background: white; padding: 20px; border-radius: 16px;
            display: inline-block; margin: 20px 0;
        }

        /* --- Gallery Grid --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding-bottom: 50px;
        }
        
        .media-card {
            background: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            border: 1px solid #334155;
            transition: transform 0.2s;
        }
        .media-card:hover { transform: scale(1.03); border-color: var(--accent-color); }
        
        .media-card img, .media-card video {
            width: 100%; height: 100%; object-fit: cover; pointer-events: none;
        }

        .video-indicator {
            position: absolute; top: 8px; right: 8px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;
        }

        /* --- Client UI (Phone) --- */
        .mobile-btn {
            background: var(--accent-color); color: #0f172a;
            width: 100%; padding: 25px; border-radius: 16px;
            font-size: 1.3rem; font-weight: bold; border: none;
            margin-top: 20px; cursor: pointer; position: relative; overflow: hidden;
        }
        .mobile-btn input {
            position: absolute; top:0; left:0; width:100%; height:100%; opacity:0;
        }

        /* --- Fullscreen Viewer with Zoom & Nav --- */
        #viewer {
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); z-index: 100;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #viewer.active { display: flex; }

        /* Media Container (Where zoom happens) */
        #viewer-content {
            position: relative;
            max-width: 90vw; max-height: 80vh;
            transition: transform 0.2s ease;
        }
        #viewer-content img, #viewer-content video {
            max-width: 100%; max-height: 80vh; display: block;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* Controls */
        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); color: white;
            border: none; padding: 20px; font-size: 2rem; cursor: pointer;
            border-radius: 50%; transition: background 0.2s;
            user-select: none;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        #prev-btn { left: 20px; }
        #next-btn { right: 20px; }

        .toolbar {
            position: absolute; bottom: 30px;
            display: flex; gap: 10px;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px;
        }
        .tool-btn {
            background: none; border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-size: 0.9rem;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.2); }

        #close-viewer {
            position: absolute; top: 20px; right: 30px; 
            color: white; font-size: 3rem; cursor: pointer; z-index: 200;
        }
    </style>
</head>
<body>

<header>
    <h1>AirGallery Pro</h1>
</header>

<div class="container">

    <div id="p-loading" class="panel active">
        <p>Starting secure server...</p>
    </div>

    <div id="p-host" class="panel">
        <h2>Scan to Connect</h2>
        <div id="qr-container"><div id="qrcode"></div></div>
        <p style="color: var(--text-secondary)">Scan with your phone to upload media</p>
    </div>

    <div id="p-gallery" class="panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2>Library</h2>
            <span style="color: #4ade80;">● Connected</span>
        </div>
        <div class="gallery-grid" id="grid"></div>
        <div id="empty-state" style="color: var(--text-secondary); margin-top: 50px;">
            No media yet. Select photos or videos on your phone.
        </div>
    </div>

    <div id="p-client" class="panel">
        <h2>Connected!</h2>
        <div class="mobile-btn">
            + Upload Media
            <input type="file" id="file-input" multiple accept="image/*,video/*">
        </div>
        <ul id="upload-logs" style="list-style:none; padding:0; margin-top:30px; text-align:left; color:#4ade80;"></ul>
    </div>

</div>

<div id="viewer">
    <div id="close-viewer">&times;</div>
    
    <button class="nav-btn" id="prev-btn">❮</button>
    <button class="nav-btn" id="next-btn">❯</button>

    <div id="viewer-content"></div>

    <div class="toolbar">
        <button class="tool-btn" onclick="adjustZoom(-0.2)">- Zoom</button>
        <button class="tool-btn" onclick="resetZoom()">Reset</button>
        <button class="tool-btn" onclick="adjustZoom(0.2)">+ Zoom</button>
    </div>
</div>

<script>
    // --- State Management ---
    const urlParams = new URLSearchParams(window.location.search);
    const targetHostId = urlParams.get('host');
    const isClient = !!targetHostId;
    const peer = new Peer(null, { debug: 1 });
    let conn = null;

    // Gallery State
    let galleryItems = []; // Stores { type: 'image'|'video', url: 'blob:...' }
    let currentIndex = 0;
    let currentZoom = 1;

    // --- Routing ---
    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // --- PeerJS Init ---
    peer.on('open', (id) => {
        isClient ? initClient(id) : initHost(id);
    });

    // ==========================================
    //  PC HOST LOGIC
    // ==========================================
    function initHost(myId) {
        showPanel('p-host');
        // Generate QR
        const link = `${window.location.origin}${window.location.pathname}?host=${myId}`;
        new QRCode(document.getElementById("qrcode"), { text: link, width: 200, height: 200 });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('open', () => showPanel('p-gallery'));
            conn.on('data', (data) => {
                if(data.file) addToGallery(data.file, data.type);
            });
            conn.on('close', () => alert("Phone disconnected"));
        });
    }

    function addToGallery(fileBlob, fileType) {
        document.getElementById('empty-state').style.display = 'none';
        
        const blobUrl = URL.createObjectURL(new Blob([fileBlob], { type: fileType }));
        const isVideo = fileType.startsWith('video');
        
        // Add to Data Store
        const itemIndex = galleryItems.length;
        galleryItems.push({
            url: blobUrl,
            type: isVideo ? 'video' : 'image'
        });

        // Add to DOM (Thumbnail)
        const grid = document.getElementById('grid');
        const card = document.createElement('div');
        card.className = 'media-card';
        card.onclick = () => openViewer(itemIndex);

        if (isVideo) {
            const vid = document.createElement('video');
            vid.src = blobUrl;
            vid.muted = true; // Auto-play muted for thumbnail effect
            // vid.play(); // Optional: play on hover or load
            
            const badge = document.createElement('div');
            badge.className = 'video-indicator';
            badge.innerText = '▶ Video';
            
            card.appendChild(badge);
            card.appendChild(vid);
        } else {
            const img = document.createElement('img');
            img.src = blobUrl;
            card.appendChild(img);
        }
        
        grid.appendChild(card); // Add to end (chronological)
    }

    // ==========================================
    //  PHONE CLIENT LOGIC
    // ==========================================
    function initClient(myId) {
        conn = peer.connect(targetHostId);
        conn.on('open', () => showPanel('p-client'));
        conn.on('error', () => alert("Connection Failed"));
    }

    document.getElementById('file-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const logs = document.getElementById('upload-logs');

        files.forEach(file => {
            conn.send({ file: file, name: file.name, type: file.type });
            const li = document.createElement('li');
            li.textContent = `✔ Sent: ${file.name}`;
            logs.prepend(li);
        });
    });

    // ==========================================
    //  VIEWER LOGIC (Zoom, Video, Nav)
    // ==========================================
    const viewer = document.getElementById('viewer');
    const contentBox = document.getElementById('viewer-content');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    function openViewer(index) {
        currentIndex = index;
        viewer.classList.add('active');
        renderViewerContent();
    }

    function renderViewerContent() {
        // Reset Zoom
        currentZoom = 1;
        updateZoom();

        // Clear previous
        contentBox.innerHTML = '';
        
        const item = galleryItems[currentIndex];
        
        if (item.type === 'video') {
            const vid = document.createElement('video');
            vid.src = item.url;
            vid.controls = true;
            vid.autoplay = true;
            vid.style.maxWidth = "100%";
            vid.style.maxHeight = "80vh";
            contentBox.appendChild(vid);
        } else {
            const img = document.createElement('img');
            img.src = item.url;
            contentBox.appendChild(img);
        }

        // Handle Nav Button Visibility
        prevBtn.style.display = currentIndex > 0 ? 'block' : 'none';
        nextBtn.style.display = currentIndex < galleryItems.length - 1 ? 'block' : 'none';
    }

    // Navigation
    function changeSlide(direction) {
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < galleryItems.length) {
            currentIndex = newIndex;
            renderViewerContent();
        }
    }
    prevBtn.onclick = (e) => { e.stopPropagation(); changeSlide(-1); };
    nextBtn.onclick = (e) => { e.stopPropagation(); changeSlide(1); };

    // Keyboard Nav
    document.addEventListener('keydown', (e) => {
        if (!viewer.classList.contains('active')) return;
        if (e.key === 'ArrowLeft') changeSlide(-1);
        if (e.key === 'ArrowRight') changeSlide(1);
        if (e.key === 'Escape') closeViewer();
    });

    // Zoom Logic
    function adjustZoom(delta) {
        currentZoom += delta;
        if (currentZoom < 0.5) currentZoom = 0.5; // Min limit
        if (currentZoom > 4) currentZoom = 4;     // Max limit
        updateZoom();
    }
    function resetZoom() {
        currentZoom = 1;
        updateZoom();
    }
    function updateZoom() {
        // Apply transform to the container holding the img/video
        contentBox.style.transform = `scale(${currentZoom})`;
    }

    // Close
    function closeViewer() {
        viewer.classList.remove('active');
        contentBox.innerHTML = ''; // Stop video playback
    }
    document.getElementById('close-viewer').onclick = closeViewer;

</script>
</body>
</html>
