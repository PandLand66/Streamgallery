<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGallery - PC Host</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a; /* Dark Slate */
            --surface-color: #1e293b;
            --accent-color: #38bdf8; /* Sky Blue */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            width: 100%;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #334155;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        h1 { margin: 0; font-weight: 600; letter-spacing: -0.5px; }

        /* --- Main Layout --- */
        .container {
            width: 90%;
            max-width: 1000px;
            margin-top: 40px;
            text-align: center;
            flex-grow: 1;
        }

        .panel { display: none; animation: slideUp 0.4s ease-out; }
        .panel.active { display: block; }

        /* --- PC Host UI --- */
        #qr-container {
            background: white;
            padding: 20px;
            border-radius: 16px;
            display: inline-block;
            margin: 20px 0;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .instruction { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 20px; }

        /* --- Phone Client UI --- */
        .mobile-btn {
            background: var(--accent-color);
            color: #0f172a;
            width: 100%;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
            position: relative;
            overflow: hidden;
        }
        .mobile-btn input {
            position: absolute; top:0; left:0; width:100%; height:100%; opacity:0;
        }
        .mobile-btn:active { transform: scale(0.98); }

        /* --- Gallery Grid --- */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding-bottom: 50px;
        }
        
        .photo-card {
            background: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 1;
            transition: transform 0.2s;
            border: 1px solid #334155;
        }
        .photo-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        
        .photo-card img {
            width: 100%; height: 100%; object-fit: cover; cursor: pointer;
        }

        /* --- Fullscreen Modal --- */
        #modal {
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #modal.open { opacity: 1; pointer-events: all; }
        #modal img { max-width: 95%; max-height: 95vh; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        #modal-close {
            position: absolute; top: 20px; right: 30px; 
            color: white; font-size: 2rem; cursor: pointer;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<header>
    <h1>AirGallery</h1>
</header>

<div class="container">

    <div id="p-loading" class="panel active">
        <p class="instruction">Establishing secure channel...</p>
    </div>

    <div id="p-host" class="panel">
        <h2>Scan to Connect</h2>
        <p class="instruction">Open your phone camera and scan this code.</p>
        <div id="qr-container"><div id="qrcode"></div></div>
        <p style="font-size: 0.9rem; color: #64748b;">Waiting for phone...</p>
    </div>

    <div id="p-gallery" class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Your Photos</h2>
            <span style="color: #4ade80; font-size: 0.9rem;">● Phone Connected</span>
        </div>
        <div class="gallery-grid" id="grid"></div>
        <div id="empty-state" class="instruction">
            Photos selected on your phone will appear here instantly.
        </div>
    </div>

    <div id="p-client" class="panel">
        <h2>Connected to PC</h2>
        <p class="instruction">Tap below to stream photos to your computer.</p>
        
        <div class="mobile-btn">
            + Select Photos
            <input type="file" id="file-input" multiple accept="image/*">
        </div>

        <div style="margin-top: 30px; text-align: left;">
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Upload History:</p>
            <ul id="upload-logs" style="list-style: none; padding: 0; color: #4ade80;"></ul>
        </div>
    </div>

</div>

<div id="modal">
    <div id="modal-close">&times;</div>
    <img id="modal-img">
</div>

<script>
    // --- Configuration ---
    // If the URL has "?host=...", this device is the PHONE (Client).
    // If not, this device is the PC (Host).
    const urlParams = new URLSearchParams(window.location.search);
    const targetHostId = urlParams.get('host');
    const isClient = !!targetHostId;

    const peer = new Peer(null, { debug: 1 });
    let conn = null;

    // --- Routing ---
    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    peer.on('open', (myId) => {
        if (isClient) {
            initClient(myId);
        } else {
            initHost(myId);
        }
    });

    peer.on('error', (err) => {
        alert("Connection Error: " + err.type);
    });

    // ==========================================
    //  PC LOGIC (Host)
    // ==========================================
    function initHost(myId) {
        showPanel('p-host');

        // Generate QR Code
        const link = `${window.location.origin}${window.location.pathname}?host=${myId}`;
        new QRCode(document.getElementById("qrcode"), {
            text: link,
            width: 200,
            height: 200,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // Listen for incoming connection from Phone
        peer.on('connection', (c) => {
            conn = c;
            
            conn.on('open', () => {
                showPanel('p-gallery');
            });

            conn.on('data', (data) => {
                if(data.file) {
                    addToGallery(data.file);
                }
            });

            conn.on('close', () => {
                alert("Phone disconnected. Refresh to reconnect.");
                location.reload();
            });
        });
    }

    function addToGallery(fileBlob) {
        document.getElementById('empty-state').style.display = 'none';
        
        const blobUrl = URL.createObjectURL(new Blob([fileBlob]));
        const grid = document.getElementById('grid');
        
        const card = document.createElement('div');
        card.className = 'photo-card';
        
        const img = document.createElement('img');
        img.src = blobUrl;
        img.onclick = () => openModal(blobUrl);
        
        card.appendChild(img);
        grid.prepend(card); // Add to top
    }

    // ==========================================
    //  PHONE LOGIC (Client)
    // ==========================================
    function initClient(myId) {
        // Connect to the PC Host ID found in URL
        conn = peer.connect(targetHostId);

        conn.on('open', () => {
            showPanel('p-client');
        });

        conn.on('close', () => {
            alert("PC Disconnected");
        });

        conn.on('error', (err) => {
            alert("Could not connect to PC.");
        });
    }

    // Handle File Input on Phone
    document.getElementById('file-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const logs = document.getElementById('upload-logs');

        files.forEach(file => {
            // Send file to PC
            conn.send({
                file: file,
                name: file.name,
                type: file.type
            });

            // Update Phone UI
            const li = document.createElement('li');
            li.textContent = `✔ Sent: ${file.name}`;
            logs.prepend(li);
        });
    });

    // ==========================================
    //  MODAL LOGIC
    // ==========================================
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modal-img');
    
    function openModal(src) {
        modalImg.src = src;
        modal.classList.add('open');
    }

    document.getElementById('modal-close').onclick = () => {
        modal.classList.remove('open');
    };
    
    // Close on background click
    modal.onclick = (e) => {
        if(e.target === modal) modal.classList.remove('open');
    }

</script>
</body>
</html>
