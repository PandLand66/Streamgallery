<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirGallery V9 (Fixed Video Controls)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --accent-color: #38bdf8;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        header {
            width: 100%;
            padding: 15px;
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid #334155;
            text-align: center;
            z-index: 50;
        }

        .main-scroll {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            text-align: center;
        }

        .panel { display: none; }
        .panel.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #qr-container {
            background: white; padding: 15px; border-radius: 12px;
            display: inline-block; margin: 20px 0;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding-bottom: 80px;
        }
        
        .media-card {
            background: var(--surface-color);
            border-radius: 12px;
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .media-card:hover { border-color: var(--accent-color); transform: scale(1.02); }
        
        .media-card img, .media-card video {
            width: 100%; height: 100%; object-fit: cover; pointer-events: none;
        }

        .date-badge {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white; font-size: 0.75rem;
            padding: 20px 10px 8px 10px;
            text-align: left;
        }

        .play-icon {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; color: rgba(255,255,255,0.8);
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .mobile-btn {
            background: var(--accent-color); color: #0f172a;
            width: 100%; padding: 25px; border-radius: 16px;
            font-size: 1.2rem; font-weight: bold; border: none;
            margin-top: 20px; cursor: pointer; position: relative; overflow: hidden;
        }
        .mobile-btn input {
            position: absolute; top:0; left:0; width:100%; height:100%; opacity:0;
        }

        #viewer {
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.95); z-index: 100;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #viewer.active { display: flex; }

        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); color: white;
            border: none; padding: 20px; font-size: 2.5rem; cursor: pointer;
            border-radius: 50%; transition: background 0.2s; z-index: 101;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        #prev-btn { left: 20px; }
        #next-btn { right: 20px; }

        #viewer-content {
            position: relative;
            max-width: 90vw; max-height: 80vh;
            display: flex; justify-content: center; align-items: center;
            cursor: default; 
        }
        
        #viewer-content.can-drag { cursor: grab; }
        #viewer-content.is-dragging { cursor: grabbing; }

        /* --- FIXED CSS HERE --- */
        #viewer-content img {
            max-width: 100%; max-height: 80vh; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            pointer-events: none; /* Keep images non-interactive for smooth dragging */
        }

        #viewer-content video {
            max-width: 100%; max-height: 80vh; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            pointer-events: auto; /* Allow clicks for video controls */
        }
        /* ---------------------- */

        .toolbar {
            position: absolute; bottom: 30px;
            display: flex; gap: 10px;
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 50px;
            z-index: 102;
            flex-wrap: wrap; justify-content: center;
        }
        .tool-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 15px; border-radius: 20px;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            font-size: 0.9rem; transition: all 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.2); }
        
        .tool-btn.active {
            background: var(--accent-color);
            color: #0f172a;
            border-color: var(--accent-color);
        }

        #close-viewer {
            position: absolute; top: 20px; right: 30px; 
            color: white; font-size: 3rem; cursor: pointer; z-index: 200;
        }

        #viewer-info {
            position: absolute; top: 30px; left: 30px;
            text-align: left;
            z-index: 200;
        }
        #viewer-date { color: var(--accent-color); font-size: 0.9rem; margin-bottom: 4px; }
        #viewer-counter { color: var(--text-secondary); font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <h3>AirGallery V9</h3>
</header>

<div class="main-scroll">
    <div class="container">

        <div id="p-loading" class="panel active">
            <p>Starting server...</p>
        </div>

        <div id="p-host" class="panel">
            <h2>Scan to Connect</h2>
            <div id="qr-container"><div id="qrcode"></div></div>
            <p style="color: var(--text-secondary)">Scan with your phone camera</p>
        </div>

        <div id="p-gallery" class="panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Library</h2>
                <span style="color: #4ade80;">● Connected</span>
            </div>
            <div class="gallery-grid" id="grid"></div>
            <div id="empty-state" style="color: var(--text-secondary); margin-top: 50px;">
                No media yet. Select photos or videos on your phone.
            </div>
        </div>

        <div id="p-client" class="panel">
            <h2>Connected!</h2>
            <div class="mobile-btn">
                <i class="bi bi-cloud-upload"></i> Upload Media
                <input type="file" id="file-input" multiple accept="image/*,video/*">
            </div>
            <ul id="upload-logs" style="list-style:none; padding:0; margin-top:30px; text-align:left; color:#4ade80;"></ul>
        </div>

    </div>
</div>

<div id="viewer" tabindex="0">
    <div id="close-viewer">&times;</div>
    
    <div id="viewer-info">
        <div id="viewer-date"></div>
        <div id="viewer-counter"></div>
    </div>

    <button class="nav-btn" id="prev-btn"><i class="bi bi-chevron-left"></i></button>
    <button class="nav-btn" id="next-btn"><i class="bi bi-chevron-right"></i></button>

    <div id="viewer-content"></div>

    <div class="toolbar">
        <button class="tool-btn" id="btn-loop" onclick="toggleLoop()"><i class="bi bi-repeat"></i> Loop</button>
        <button class="tool-btn" id="btn-slide" onclick="toggleSlideshow()"><i class="bi bi-play-fill"></i> Slideshow</button>
        
        <div style="width:1px; background:rgba(255,255,255,0.3); height:20px; margin:0 5px;"></div>

        <button class="tool-btn" onclick="zoom(-0.2)"><i class="bi bi-zoom-out"></i></button>
        <button class="tool-btn" onclick="resetZoom()">1x</button>
        <button class="tool-btn" onclick="zoom(0.2)"><i class="bi bi-zoom-in"></i></button>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const hostId = urlParams.get('host');
    const isClient = !!hostId;
    const peer = new Peer(null, { debug: 1 });
    let conn = null;

    let galleryItems = []; 
    let currentIndex = 0;
    
    // Zoom/Drag State
    let currentZoom = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;

    // Slideshow/Loop State
    let isLooping = false;
    let isSlideshow = false;
    let slideTimer = null;

    peer.on('open', (id) => {
        isClient ? initClient(id) : initHost(id);
    });

    function showPanel(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function initHost(myId) {
        showPanel('p-host');
        const link = `${window.location.origin}${window.location.pathname}?host=${myId}`;
        new QRCode(document.getElementById("qrcode"), { text: link, width: 200, height: 200 });

        peer.on('connection', (c) => {
            conn = c;
            conn.on('open', () => showPanel('p-gallery'));
            
            conn.on('data', (data) => {
                if(data.file) {
                    addToGallery(data.file, data.name, data.type, data.date);
                }
            });
            conn.on('close', () => alert("Phone disconnected"));
        });
    }

    function addToGallery(fileData, fileName, fileType, fileDate) {
        document.getElementById('empty-state').style.display = 'none';
        
        const blob = new Blob([fileData], { type: fileType });
        const blobUrl = URL.createObjectURL(blob);
        const isVideo = fileType.startsWith('video');

        const dateObj = new Date(fileDate);
        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        galleryItems.push({
            url: blobUrl,
            type: isVideo ? 'video' : 'image',
            name: fileName,
            date: dateStr
        });

        const index = galleryItems.length - 1;

        const grid = document.getElementById('grid');
        const card = document.createElement('div');
        card.className = 'media-card';
        card.onclick = () => openViewer(index);

        if (isVideo) {
            const vid = document.createElement('video');
            vid.src = blobUrl;
            vid.muted = true; 
            const icon = document.createElement('div');
            icon.className = 'play-icon';
            icon.innerHTML = '<i class="bi bi-play-circle-fill"></i>';
            card.appendChild(vid);
            card.appendChild(icon);
        } else {
            const img = document.createElement('img');
            img.src = blobUrl;
            card.appendChild(img);
        }

        const dateBadge = document.createElement('div');
        dateBadge.className = 'date-badge';
        dateBadge.innerText = dateStr;
        card.appendChild(dateBadge);
        
        grid.appendChild(card);
    }

    function initClient(myId) {
        conn = peer.connect(hostId);
        conn.on('open', () => showPanel('p-client'));
        conn.on('error', () => alert("Connection Failed"));
    }

    document.getElementById('file-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const logs = document.getElementById('upload-logs');

        files.forEach(file => {
            conn.send({ 
                file: file, 
                name: file.name, 
                type: file.type,
                date: file.lastModified
            });
            
            const li = document.createElement('li');
            li.textContent = `✔ Sent: ${file.name}`;
            logs.prepend(li);
        });
    });

    // ==========================================
    //  VIEWER & FEATURES
    // ==========================================
    const viewer = document.getElementById('viewer');
    const contentBox = document.getElementById('viewer-content');

    function openViewer(index) {
        currentIndex = index;
        viewer.classList.add('active');
        viewer.focus();
        renderViewerContent();
    }

    function renderViewerContent() {
        resetZoom(); 
        contentBox.innerHTML = '';
        clearTimeout(slideTimer); 

        const item = galleryItems[currentIndex];
        
        document.getElementById('viewer-counter').innerText = `${currentIndex + 1} / ${galleryItems.length}`;
        document.getElementById('viewer-date').innerText = item.date;

        if (item.type === 'video') {
            const vid = document.createElement('video');
            vid.src = item.url;
            vid.controls = true;
            vid.autoplay = true;
            vid.style.maxHeight = "80vh";
            
            // Fix: Prevent browser from dragging the video element itself
            vid.draggable = false; 
            
            vid.loop = isLooping;

            if (isSlideshow) {
                vid.loop = false; 
                vid.onended = () => changeSlide(1);
            }

            contentBox.appendChild(vid);
        } else {
            const img = document.createElement('img');
            img.src = item.url;
            contentBox.appendChild(img);
            
            if (isSlideshow) {
                slideTimer = setTimeout(() => changeSlide(1), 3000); 
            }
        }
        
        updateNavButtons();
    }

    function changeSlide(dir) {
        let newIndex = currentIndex + dir;
        
        if (newIndex >= galleryItems.length) newIndex = 0;
        if (newIndex < 0) newIndex = galleryItems.length - 1;

        currentIndex = newIndex;
        renderViewerContent();
    }
    
    function updateNavButtons() {
        document.getElementById('prev-btn').style.display = 'block';
        document.getElementById('next-btn').style.display = 'block';
    }

    document.getElementById('prev-btn').onclick = (e) => { 
        e.stopPropagation(); stopSlideshow(); changeSlide(-1); 
    };
    document.getElementById('next-btn').onclick = (e) => { 
        e.stopPropagation(); stopSlideshow(); changeSlide(1); 
    };

    function toggleLoop() {
        isLooping = !isLooping;
        const btn = document.getElementById('btn-loop');
        
        if (isLooping) btn.classList.add('active');
        else btn.classList.remove('active');

        const vid = contentBox.querySelector('video');
        if (vid) vid.loop = isLooping;
    }

    function toggleSlideshow() {
        isSlideshow = !isSlideshow;
        const btn = document.getElementById('btn-slide');
        
        if (isSlideshow) {
            btn.classList.add('active');
            btn.innerHTML = '<i class="bi bi-pause-fill"></i> Stop';
            renderViewerContent(); 
        } else {
            stopSlideshow();
        }
    }

    function stopSlideshow() {
        isSlideshow = false;
        clearTimeout(slideTimer);
        const btn = document.getElementById('btn-slide');
        btn.classList.remove('active');
        btn.innerHTML = '<i class="bi bi-play-fill"></i> Slideshow';
        
        const vid = contentBox.querySelector('video');
        if (vid) vid.onended = null;
    }

    // --- KEYBINDS ---
    document.addEventListener('keydown', (e) => {
        if (!viewer.classList.contains('active')) return;
        
        if (e.key === 'ArrowLeft') { stopSlideshow(); changeSlide(-1); }
        else if (e.key === 'ArrowRight') { stopSlideshow(); changeSlide(1); }
        else if (e.key === 'Escape') closeViewer();
        
        else if (e.key === '+' || e.key === '=' || e.key === 'ArrowUp') zoom(0.2);
        else if (e.key === '-' || e.key === '_' || e.key === 'ArrowDown') zoom(-0.2);
        else if (e.key === '0') resetZoom();

        else if (e.key.toLowerCase() === 'l') toggleLoop();
        else if (e.key === ' ') { e.preventDefault(); toggleSlideshow(); }
    });

    // --- ZOOM & DRAG ---
    function zoom(amount) {
        currentZoom += amount;
        if (currentZoom < 0.1) currentZoom = 0.1;
        if (currentZoom <= 1) { currentZoom = 1; translateX = 0; translateY = 0; }
        updateTransform();
    }
    
    function resetZoom() {
        currentZoom = 1; translateX = 0; translateY = 0;
        updateTransform();
    }

    function updateTransform() {
        contentBox.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
        if (currentZoom > 1) contentBox.classList.add('can-drag');
        else contentBox.classList.remove('can-drag', 'is-dragging');
    }

    contentBox.addEventListener('mousedown', startDrag);
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('mousemove', drag);

    function startDrag(e) {
        // Fix: If we are not zoomed in, allow default behavior (video controls)
        if (currentZoom <= 1) return;
        
        e.preventDefault(); isDragging = true;
        startX = e.clientX - translateX; startY = e.clientY - translateY;
        contentBox.classList.add('is-dragging');
    }

    function endDrag() { isDragging = false; contentBox.classList.remove('is-dragging'); }

    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        translateX = e.clientX - startX; translateY = e.clientY - startY;
        updateTransform();
    }

    function closeViewer() {
        stopSlideshow();
        viewer.classList.remove('active');
        contentBox.innerHTML = ''; 
    }
    document.getElementById('close-viewer').onclick = closeViewer;

</script>
</body>
</html>
