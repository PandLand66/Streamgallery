<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Device Photo Stream</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-color: #050A18;
            --panel-bg: #0F1C35;
            --accent-blue: #3A6EA5;
            --accent-hover: #5086C1;
            --text-main: #FFFFFF;
            --text-secondary: #A0AAB5;
            --danger: #FF4C4C;
            --border-radius: 12px;
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-family);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Landing Modal (Role Selection) --- */
        #landing-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 10, 24, 0.95);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .role-card {
            background: var(--panel-bg);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .role-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .role-btn {
            padding: 1rem 2rem;
            border-radius: 10px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 140px;
        }

        .role-btn i { font-size: 2rem; }

        .btn-sender { background: var(--accent-blue); color: white; }
        .btn-sender:hover { background: var(--accent-hover); transform: translateY(-3px); }

        .btn-viewer { background: transparent; border: 2px solid var(--text-secondary); color: var(--text-secondary); }
        .btn-viewer:hover { border-color: white; color: white; transform: translateY(-3px); }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(15,28,53,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #1e293b;
            color: #94a3b8;
        }
        .status-badge.connected { background: rgba(16, 185, 129, 0.2); color: #34d399; }

        /* --- Main Layout --- */
        .container {
            display: flex;
            flex: 1;
            padding: 1rem;
            gap: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: margin 0.3s ease;
        }
        
        body.viewer-mode .sidebar {
            display: none;
        }
        
        body.viewer-mode .gallery-section {
            padding-left: 0;
        }

        .qr-card {
            background-color: var(--panel-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #qrcode {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        #qrcode img {
            display: block; 
        }

        .link-box {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin-top: 10px;
            user-select: all;
            cursor: pointer;
        }

        /* Gallery */
        .gallery-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: rgba(255,255,255,0.02);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .toolbar {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-blue { background: var(--accent-blue); color: white; }
        .btn-blue:hover { background: var(--accent-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); }
        .btn-outline:hover { color: white; border-color: white; }
        .btn-red { background: rgba(255, 76, 76, 0.1); color: var(--danger); }
        .btn-red:hover { background: rgba(255, 76, 76, 0.2); }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .photo-card {
            aspect-ratio: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .photo-card img {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.3s;
        }
        
        .photo-card:hover img { transform: scale(1.05); }

        /* Viewer Mode Specifics */
        .viewer-controls { display: none; }
        body.viewer-mode .viewer-controls { display: flex; width: 100%; justify-content: space-between; align-items: center; margin-bottom: 1rem;}
        body.viewer-mode .sender-controls { display: none; }

        /* --- Lightbox / Slideshow --- */
        .lightbox {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .lightbox.active { display: flex; }

        .lightbox img {
            max-width: 100%;
            max-height: 100vh;
            object-fit: contain;
        }

        .lb-controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 20px;
            background: rgba(20,20,20,0.8);
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 3001;
        }

        .lb-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .lb-btn:hover { background: rgba(255,255,255,0.2); }

        .lb-close {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            z-index: 3002;
            background: none; border: none;
        }

        .lb-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 3001;
        }
        .lb-prev { left: 0; }
        .lb-next { right: 0; }
        .lb-nav:hover { background: rgba(0,0,0,0.8); }

        @media (max-width: 768px) {
            .container { flex-direction: column; padding: 0.5rem; }
            .sidebar { width: 100%; }
            .role-buttons { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>

    <div id="landing-overlay">
        <div class="role-card">
            <h1 style="margin-bottom: 0.5rem;">Photo Stream</h1>
            <p style="color: var(--text-secondary);">Connect devices seamlessly over the web.</p>
            
            <div class="role-buttons">
                <button class="role-btn btn-sender" id="btn-start-sender">
                    <i class="fas fa-satellite-dish"></i>
                    Sender
                </button>
                <button class="role-btn btn-viewer" id="btn-start-viewer">
                    <i class="fas fa-eye"></i>
                    Viewer
                </button>
            </div>
            <p style="margin-top: 1.5rem; font-size: 0.8rem; color: #555;">No installation required.</p>
        </div>
    </div>

    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-bolt" style="color: var(--accent-blue);"></i>
            <h2 style="font-size: 1.2rem;">Stream</h2>
        </div>
        <div class="status-badge" id="connectionStatus">Disconnected</div>
    </header>

    <div class="container">
        <aside class="sidebar" id="senderSidebar">
            <div class="qr-card">
                <h3>Scan to View</h3>
                <div id="qrcode"></div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 10px;">
                    Scan with other device to connect.
                </p>
                <div class="link-box" id="shareLink">Generating link...</div>
            </div>
            
            <div style="background: var(--panel-bg); padding: 1.5rem; border-radius: 12px;">
                <h4 style="margin-bottom: 10px;">Controls</h4>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px;">
                    Uploading photos here will instantly send them to connected viewers.
                </p>
            </div>
        </aside>

        <section class="gallery-section">
            <div class="viewer-controls">
                <h3>Shared Gallery</h3>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    <i class="fas fa-sync fa-spin" id="syncIcon" style="display:none; margin-right:5px;"></i>
                    <span id="photoCount">0 photos</span>
                </div>
            </div>

            <div class="sender-controls">
                <div class="toolbar">
                    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                    <button class="btn btn-blue" id="btn-add-photos">
                        <i class="fas fa-plus"></i> Add Photos
                    </button>
                    <button class="btn btn-red" id="btn-clear-gallery">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>

            <div class="gallery-grid" id="galleryGrid">
                </div>
        </section>
    </div>

    <div class="lightbox" id="lightbox">
        <button class="lb-close" id="btn-close-lightbox">&times;</button>
        <button class="lb-nav lb-prev" id="btn-prev-slide">&#10094;</button>
        <img src="" id="lbImage" alt="Fullscreen">
        <button class="lb-nav lb-next" id="btn-next-slide">&#10095;</button>

        <div class="lb-controls">
            <button class="lb-btn" id="btn-play-slideshow" title="Play/Pause Slideshow">
                <i class="fas fa-play"></i>
            </button>
            <span style="color:white; font-size: 0.9rem; display: flex; align-items: center; margin-left: 10px;">
                <input type="range" id="speedRange" min="1" max="5" value="3" style="width: 80px; margin-right: 5px;">
                <span id="speedDisplay">3s</span>
            </span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Variables ---
            let peer = null;
            let conn = null;
            let myId = null;
            let role = 'sender'; 
            let photos = []; 
            let connections = []; 
            let currentIndex = 0;
            let slideshowInterval = null;
            let isPlaying = false;

            // --- Elements ---
            const landingOverlay = document.getElementById('landing-overlay');
            const galleryGrid = document.getElementById('galleryGrid');
            const fileInput = document.getElementById('fileInput');
            
            // --- Initialization Logic ---
            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('host');

            if (hostId) {
                // Auto-start as viewer if URL param exists
                startApp('viewer', hostId);
            }

            // --- Event Listeners for Buttons ---
            document.getElementById('btn-start-sender').addEventListener('click', () => startApp('sender'));
            document.getElementById('btn-start-viewer').addEventListener('click', () => startApp('viewer-manual'));
            
            document.getElementById('btn-add-photos').addEventListener('click', () => fileInput.click());
            document.getElementById('btn-clear-gallery').addEventListener('click', clearGallery);
            document.getElementById('shareLink').addEventListener('click', copyLink);
            
            // Lightbox listeners
            document.getElementById('btn-close-lightbox').addEventListener('click', closeLightbox);
            document.getElementById('btn-prev-slide').addEventListener('click', () => changeSlide(-1));
            document.getElementById('btn-next-slide').addEventListener('click', () => changeSlide(1));
            document.getElementById('btn-play-slideshow').addEventListener('click', toggleSlideshow);

            // --- Main App Start ---
            function startApp(selectedRole, targetHostId = null) {
                role = selectedRole === 'viewer-manual' ? 'viewer' : selectedRole;
                landingOverlay.style.display = 'none';

                if (role === 'viewer') {
                    document.body.classList.add('viewer-mode');
                    initPeerViewer(targetHostId || prompt("Enter Host ID (or scan QR code):"));
                } else {
                    initPeerSender();
                }
            }

            // --- Networking (PeerJS) ---
            function initPeerSender() {
                // Ensure PeerJS is loaded
                if (typeof Peer === 'undefined') {
                    alert("Network library failed to load. Please refresh.");
                    return;
                }

                peer = new Peer(null, { debug: 2 });

                peer.on('open', (id) => {
                    myId = id;
                    generateQR(id);
                    updateStatus('Waiting for connection...', false);
                });

                peer.on('connection', (c) => {
                    connections.push(c);
                    updateStatus('Viewer Connected', true);
                    
                    // Sync existing photos
                    if(photos.length > 0) {
                        setTimeout(() => {
                            if(c.open) c.send({ type: 'SYNC_ALL', data: photos });
                        }, 500);
                    }
                });

                peer.on('error', (err) => {
                    console.error(err);
                    alert("Connection Error: " + err.type);
                });
            }

            function initPeerViewer(hostIdToConnect) {
                if(!hostIdToConnect) {
                    alert("No Host ID provided.");
                    location.reload();
                    return;
                }

                updateStatus('Connecting...', false);
                peer = new Peer(null, { debug: 2 });

                peer.on('open', (id) => {
                    conn = peer.connect(hostIdToConnect, { reliable: true });

                    conn.on('open', () => {
                        updateStatus('Connected to Host', true);
                    });

                    conn.on('data', (data) => {
                        handleData(data);
                    });

                    conn.on('close', () => {
                        alert("Host disconnected");
                        updateStatus('Disconnected', false);
                    });
                });

                peer.on('error', (err) => {
                    console.error(err);
                    alert("Connection Error: " + err.type);
                });
            }

            function handleData(packet) {
                if (packet.type === 'SYNC_ALL') {
                    document.getElementById('syncIcon').style.display = 'inline-block';
                    photos = packet.data;
                    renderGallery();
                    setTimeout(() => {
                        document.getElementById('syncIcon').style.display = 'none';
                    }, 1000);
                }
                if (packet.type === 'ADD_PHOTO') {
                    photos.push(packet.data);
                    renderGallery();
                }
                if (packet.type === 'CLEAR') {
                    photos = [];
                    renderGallery();
                }
            }

            // --- Sender Functions ---
            function generateQR(id) {
                const baseUrl = window.location.href.split('?')[0];
                const fullLink = `${baseUrl}?host=${id}`;
                
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = "";
                new QRCode(qrContainer, {
                    text: fullLink,
                    width: 180,
                    height: 180
                });

                document.getElementById('shareLink').textContent = fullLink;
            }

            function copyLink() {
                const text = document.getElementById('shareLink').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    alert("Link copied!");
                });
            }

            // --- File Handling ---
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if(files.length === 0) return;

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;
                        photos.push(base64);
                        renderGallery();
                        broadcast({ type: 'ADD_PHOTO', data: base64 });
                    };
                    reader.readAsDataURL(file);
                });
                fileInput.value = ''; // Reset
            });

            function clearGallery() {
                if(confirm("Delete all photos for everyone?")) {
                    photos = [];
                    renderGallery();
                    broadcast({ type: 'CLEAR' });
                }
            }

            function broadcast(packet) {
                connections.forEach(c => {
                    if(c.open) c.send(packet);
                });
            }

            // --- Rendering ---
            function renderGallery() {
                const countLabel = document.getElementById('photoCount');
                galleryGrid.innerHTML = '';
                countLabel.textContent = `${photos.length} photo${photos.length !== 1 ? 's' : ''}`;

                if (photos.length === 0) {
                    galleryGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:2rem; color:var(--text-secondary);">
                        <i class="fas fa-image" style="font-size:2rem; margin-bottom:10px;"></i><br>Gallery is empty
                    </div>`;
                    return;
                }

                photos.forEach((src, index) => {
                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.innerHTML = `<img src="${src}" loading="lazy">`;
                    card.onclick = () => openLightbox(index);
                    galleryGrid.appendChild(card);
                });
            }

            function updateStatus(msg, isConnected) {
                const badge = document.getElementById('connectionStatus');
                badge.textContent = msg;
                if(isConnected) badge.classList.add('connected');
                else badge.classList.remove('connected');
            }

            // --- Lightbox / Slideshow ---
            const lightbox = document.getElementById('lightbox');
            const lbImg = document.getElementById('lbImage');
            const playBtnIcon = document.querySelector('#btn-play-slideshow i');

            function openLightbox(index) {
                currentIndex = index;
                updateSlide();
                lightbox.classList.add('active');
            }

            function closeLightbox() {
                stopSlideshow();
                lightbox.classList.remove('active');
            }

            function changeSlide(direction) {
                if(photos.length === 0) return;
                currentIndex += direction;
                if (currentIndex >= photos.length) currentIndex = 0;
                if (currentIndex < 0) currentIndex = photos.length - 1;
                updateSlide();
            }

            function updateSlide() {
                lbImg.src = photos[currentIndex];
            }

            function toggleSlideshow() {
                if (isPlaying) stopSlideshow();
                else startSlideshow();
            }

            function startSlideshow() {
                isPlaying = true;
                playBtnIcon.className = "fas fa-pause";
                const speed = document.getElementById('speedRange').value * 1000;
                
                slideshowInterval = setInterval(() => {
                    changeSlide(1);
                }, speed);
            }

            function stopSlideshow() {
                isPlaying = false;
                playBtnIcon.className = "fas fa-play";
                clearInterval(slideshowInterval);
            }

            // Speed slider
            document.getElementById('speedRange').addEventListener('input', (e) => {
                document.getElementById('speedDisplay').textContent = e.target.value + 's';
                if (isPlaying) {
                    stopSlideshow();
                    startSlideshow();
                }
            });

            // Keyboard support
            document.addEventListener('keydown', (e) => {
                if (!lightbox.classList.contains('active')) return;
                if (e.key === 'ArrowLeft') changeSlide(-1);
                if (e.key === 'ArrowRight') changeSlide(1);
                if (e.key === 'Escape') closeLightbox();
                if (e.key === ' ') toggleSlideshow();
            });
        });
    </script>
</body>
</html>
